name: 🧪 Test & Quality Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Lint
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📋 Install dependencies
        run: npm ci

      - name: 🔍 Check file structure
        run: |
          echo "🔍 Checking required files..."
          
          required_files=(
            "index.html"
            "styles.css" 
            "script.js"
            "api/telegram.js"
            "api/chat.js"
            "vercel.json"
            "package.json"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file missing"
              exit 1
            fi
          done

      - name: 🔧 Validate package.json
        run: |
          echo "🔧 Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            console.log('✅ Package name:', pkg.name);
            console.log('✅ Version:', pkg.version);
            console.log('✅ Dependencies:', Object.keys(pkg.dependencies || {}).length);
          "

      - name: 📝 Validate HTML
        run: |
          echo "📝 Checking HTML structure..."
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "✅ Valid HTML5 doctype"
          else
            echo "❌ Missing HTML5 doctype"
            exit 1
          fi
          
          if grep -q "<title>" index.html; then
            echo "✅ Title tag found"
          else
            echo "❌ Missing title tag"
            exit 1
          fi

      - name: 🎨 Validate CSS
        run: |
          echo "🎨 Checking CSS structure..."
          if [ -s "styles.css" ]; then
            echo "✅ CSS file is not empty"
          else
            echo "❌ CSS file is empty"
            exit 1
          fi

      - name: ⚡ Validate JavaScript
        run: |
          echo "⚡ Checking JavaScript syntax..."
          node -c script.js && echo "✅ script.js syntax OK"
          node -c api/telegram.js && echo "✅ api/telegram.js syntax OK"
          node -c api/chat.js && echo "✅ api/chat.js syntax OK"

      - name: 🔧 Test dev server
        run: |
          echo "🔧 Testing dev server startup..."
          timeout 10s node dev-server.js || echo "✅ Dev server starts successfully"

      - name: 📊 Generate report
        if: always()
        run: |
          echo "📊 === Quality Report ==="
          echo "📁 Files checked: ✅"
          echo "📝 HTML validated: ✅"
          echo "🎨 CSS validated: ✅"
          echo "⚡ JS syntax checked: ✅"
          echo "🔧 Server tested: ✅"
          echo "========================" 