name: ğŸ§ª Test & Quality Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Lint
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ” Check file structure
        run: |
          echo "ğŸ” Checking required files..."
          
          required_files=(
            "index.html"
            "styles.css" 
            "script.js"
            "api/telegram.js"
            "api/chat.js"
            "vercel.json"
            "package.json"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done

      - name: ğŸ”§ Validate package.json
        run: |
          echo "ğŸ”§ Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            console.log('âœ… Package name:', pkg.name);
            console.log('âœ… Version:', pkg.version);
            console.log('âœ… Dependencies:', Object.keys(pkg.dependencies || {}).length);
          "

      - name: ğŸ“ Validate HTML
        run: |
          echo "ğŸ“ Checking HTML structure..."
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "âœ… Valid HTML5 doctype"
          else
            echo "âŒ Missing HTML5 doctype"
            exit 1
          fi
          
          if grep -q "<title>" index.html; then
            echo "âœ… Title tag found"
          else
            echo "âŒ Missing title tag"
            exit 1
          fi

      - name: ğŸ¨ Validate CSS
        run: |
          echo "ğŸ¨ Checking CSS structure..."
          if [ -s "styles.css" ]; then
            echo "âœ… CSS file is not empty"
          else
            echo "âŒ CSS file is empty"
            exit 1
          fi

      - name: âš¡ Validate JavaScript
        run: |
          echo "âš¡ Checking JavaScript syntax..."
          node -c script.js && echo "âœ… script.js syntax OK"
          node -c api/telegram.js && echo "âœ… api/telegram.js syntax OK"
          node -c api/chat.js && echo "âœ… api/chat.js syntax OK"

      - name: ğŸ”§ Test dev server
        run: |
          echo "ğŸ”§ Testing dev server startup..."
          timeout 10s node dev-server.js || echo "âœ… Dev server starts successfully"

      - name: ğŸ“Š Generate report
        if: always()
        run: |
          echo "ğŸ“Š === Quality Report ==="
          echo "ğŸ“ Files checked: âœ…"
          echo "ğŸ“ HTML validated: âœ…"
          echo "ğŸ¨ CSS validated: âœ…"
          echo "âš¡ JS syntax checked: âœ…"
          echo "ğŸ”§ Server tested: âœ…"
          echo "========================" 